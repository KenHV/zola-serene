{% import 'macros/math.html' as macro_math -%}
{% extends "_base.html" %}

{% block page %}post{% endblock page %}
{% block lang -%}
{%- set blog_section_path = config.extra.blog_section_path | trim_start_matches(pat="/") -%}
{%- set section_md_path = blog_section_path ~ "/_index.md" -%}
{%- set section = get_section(path=section_md_path, metadata_only=true) -%}
{%- if page.extra.lang %}{{page.extra.lang}}{% elif section.extra.lang %}{{section.extra.lang}}{% else %}{{page.lang}}{% endif -%}
{%- endblock lang %}
{% block title %}{{ page.title | safe}} | {{ config.title | safe }}{% endblock title %}
{% block desc %}
{% if page.banner %}
  {% set banner_url = get_url(path=page.banner) %}
  {% set banner_meta = get_image_metadata(path=page.banner) %}
{% else %}
  {% set banner_url = get_url(path=config.extra.banner) %}
  {% set banner_meta = get_image_metadata(path=config.extra.banner) %}  
{% endif %}
<meta name="description" content="{{ page.description | safe }}" />
<meta itemprop="name" content="{{ page.title | safe }} | {{ config.title | safe}}">
<meta itemprop="description" content="{{ page.description | safe }}">
<meta itemprop="image" content="{{ banner_url | safe }}">

<meta property="og:site_name" content="{{ config.title | safe }}" />
<meta property="og:title" content="{{ page.title | safe }} | {{ config.title | safe}}" />
<meta property="og:type" content="article" />
<meta property="og:url" content="{{ current_url }}" />
<meta property="og:description" content="{{ page.description | safe }}" />
<meta property="og:image" content="{{ banner_url | safe }}" />
<meta property="og:image:width" content="{{ banner_meta.width }}" />
<meta property="og:image:height" content="{{ banner_meta.height }}" />

<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content="{{ current_url }}" />
<meta property="twitter:title" content="{{ page.title | safe }} | {{ config.title | safe}}" />
<meta property="twitter:description" content="{{ page.description | safe }}" />
<meta property="twitter:image" content="{{ banner_url | safe }}" />
{% if config.extra.twitter_username %}
  <meta property="twitter:site" content="{{ config.extra.twitter_username | safe}}" />
  <meta property="twitter:creator" content="{{ config.extra.twitter_username | safe}}" />
{% endif %}

<link rel="canonical" href="{{ current_url | safe }}" />
<meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
{% endblock desc %}

{% block head %}
{% if config.markdown.highlight_theme == "css" %}
<link id="hl" rel="stylesheet" type="text/css" href="/hl-light.css" />
{% endif %}
{% if page.extra.math %}
  {{ macro_math::math_render(style = page.extra.math) }}
{% endif %}
{% endblock head %}

{% block content %}
{% include "_header.html" %}
<div id="wrapper">
  <div id="blank">
    {% if config.extra.back_to_top %}
    <button id="back-to-top" aria-label="back to top">
      {% set icon = load_data(path="static/icon/arrow-up.svg") %}
      {{ icon | safe }}
    </button>
    {% endif %}
  </div>
  <aside>
    {% if page.extra.toc is defined %}{% set show_toc = page.extra.toc %}{% else %}{% set show_toc = config.extra.toc %}{% endif %}
    {% if show_toc and page.toc %}
    <nav>
      <ul>
        {% for h2 in page.toc %}
        <li>
          <a class="h2" href="#{{ h2.id | safe }}">{{ h2.title }}</a>
          {% if h2.children %}
          <ul>
            {% for h3 in h2.children %}
            <li>
              <a class="h3" href="#{{ h3.id | safe }}">{{ h3.title }}</a>
            </li>
            {% endfor %}
          </ul>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
    </nav>
    {% endif %}
  </aside>
  <main>
    <div>
      {% if page.extra.copy is defined %}{% set allow_copy = page.extra.copy %}{% else %}{% set allow_copy = config.extra.copy %}{% endif %}
      {% if allow_copy %}
      {% set copy_icon = load_data(path="static/icon/copy.svg") %}
      {% set check_icon = load_data(path="static/icon/check.svg") %}
      <div id="copy-cfg" style="display: none;" data-copy-icon="{{ copy_icon }}" data-check-icon="{{ check_icon }}"></div>
      {% endif %}
      {% set backlink_icon = load_data(path="static/icon/backlink.svg") %}
      <article class="prose" data-backlink-icon="{{ backlink_icon }}">
        <h1>{{ page.title }}</h1>
        <div id="post-info">
          <div id="date">
            <span id="publish">{{ page.date | date }}</span>
            {% if page.updated and page.updated != page.date -%}
            <span>Updated on <span id="updated">{{ page.updated | date }}</span></span>
            {% endif -%}
          </div>

          {% if page.extra.display_tags is defined %}{% set display_tags = page.extra.display_tags %}{% elif config.extra.display_tags is defined %}{% set display_tags = config.extra.display_tags %}{% else %}{% set display_tags = true %}{% endif %}

          {% if page.taxonomies.tags is defined and display_tags == true %}
          <div id="tags">
            {% for tag in page.taxonomies.tags -%}
            {% set tag_slugify = tag | slugify -%}
            <a class="instant" href="{{ config.base_url ~ '/tags/' ~ tag_slugify }}"><span>#</span>{{ tag }}</a>
            {%- endfor %}
          </div>
          {% endif %}
        </div>

        {% if page.extra.outdate_alert is defined %}{% set show_outdate_alert = page.extra.outdate_alert %}{% else %}{% set show_outdate_alert = config.extra.outdate_alert %}{% endif %}
        {% if page.extra.outdate_alert_days is defined %}{% set outdate_alert_days = page.extra.outdate_alert_days %}{% else %}{% set outdate_alert_days = config.extra.outdate_alert_days %}{% endif %}

        {% if show_outdate_alert -%}
        <blockquote id="outdate_alert" class="callout alert hidden" data-days="{{ outdate_alert_days }}"
          data-alert-text-before="{{ config.extra.outdate_alert_text_before }}"
          data-alert-text-after="{{ config.extra.outdate_alert_text_after }}">
          {% set icon = load_data(path="static/icon/alert.svg") %}
          <div class="icon">
            {{ icon | safe }}
          </div>
          <div class="content"></div>
        </blockquote>
        {% endif %}

        {% if page.extra.truncate_summary is defined %}{% set truncate_summary = page.extra.truncate_summary %}{% elif config.extra.truncate_summary is defined %}{% set truncate_summary = config.extra.truncate_summary %}{% else %}{% set truncate_summary = false %}{% endif %}

        {% if truncate_summary == true and page.summary %}
          {{ page.content | trim_start_matches(pat=page.summary) | safe }}
        {% else %}
          {{ page.content | safe }}
        {% endif %}
      </article>

      {% if page.extra.comment is defined %}{% set show_comment = page.extra.comment %}{% else %}{% set show_comment = config.extra.comment %}{% endif %}
      {% if show_comment %}
      <div class="giscus"></div>
      {% include "_giscus_script.html" %}
      {% endif %}
    </div>

    {% include "_footer.html" %}
  </main>
</div>
{% endblock content %}

{% block script %}
<script src="/js/lightense.min.js"></script>
{% if page.extra.mermaid %}
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script>
{% endif %}
{% endblock script %}